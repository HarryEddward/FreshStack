name: Apply Docker Swarm Secrets to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Manage SSL Secrets on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e

            echo "ğŸ“¥ Actualizando secretos en Docker Swarm..."

            # Generar timestamp para versionado de secretos
            TIMESTAMP=$(date +%s)
            
            # Crear nuevos secretos con nombres versionados
            echo "ğŸ” Creando nuevos secretos SSL..."
            echo "${{ secrets.SSL_CERT }}" | sudo docker secret create ssl_cert_${TIMESTAMP} -
            echo "${{ secrets.SSL_KEY }}" | sudo docker secret create ssl_key_${TIMESTAMP} -

            # Actualizar el docker-compose.yml temporalmente para usar los nuevos secretos
            echo "ğŸ“ Actualizando configuraciÃ³n de Traefik..."
            cd /home/ubuntu/FreshStack/traefik
            
            # Backup del compose original
            sudo cp docker-compose.yml docker-compose.yml.backup

            # Actualizar referencias de secretos en el compose
            sudo sed -i "s/ssl_cert$/ssl_cert_${TIMESTAMP}/g" docker-compose.yml
            sudo sed -i "s/ssl_key$/ssl_key_${TIMESTAMP}/g" docker-compose.yml

            # Redeploy de la stack con los nuevos secretos
            echo "ğŸš€ Desplegando stack con nuevos secretos..."
            sudo docker stack deploy -c docker-compose.yml cafebuy-traefik

            # Esperar a que el servicio se actualice
            echo "â³ Esperando a que el servicio se actualice..."
            sleep 30

            # Verificar que el servicio estÃ¡ funcionando
            if sudo docker service ls | grep -q "cafebuy-traefik_traefik.*replicated.*1/1"; then
              echo "âœ… Servicio actualizado correctamente"
              
              # Limpiar secretos antiguos (excepto los que acabamos de crear)
              echo "ğŸ§¹ Limpiando secretos antiguos..."
              sudo docker secret ls --format "{{.Name}}" | grep -E "^ssl_(cert|key)_[0-9]+$" | grep -v "_${TIMESTAMP}$" | head -10 | xargs -r sudo docker secret rm || true
              
              # TambiÃ©n intentar limpiar los secretos base si existen y no estÃ¡n en uso
              sudo docker secret rm ssl_cert ssl_key 2>/dev/null || echo "â„¹ï¸  Secretos base no encontrados o aÃºn en uso"
              
            else
              echo "âŒ Error: El servicio no se actualizÃ³ correctamente"
              echo "ğŸ”„ Restaurando configuraciÃ³n anterior..."
              sudo cp docker-compose.yml.backup docker-compose.yml
              sudo docker stack deploy -c docker-compose.yml cafebuy-traefik
              exit 1
            fi

            # Restaurar el compose original para mantener consistencia
            sudo mv docker-compose.yml.backup docker-compose.yml

            echo "âœ… Secrets actualizados exitosamente"
            echo "ğŸš€ Despliegue completado: $(date)"