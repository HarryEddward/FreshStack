name: Apply Docker Swarm Secrets to VPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    if: false
    runs-on: ubuntu-latest
    steps:
      - name: Manage SSL Secrets on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e

            echo "📥 Actualizando secretos en Docker Swarm..."

            # Parar el servicio que usa los secretos
            echo "⏸️ Deteniendo servicio para actualizar secretos..."
            sudo docker service rm cafebuy-traefik_traefik || true
            
            # Esperar a que el servicio se detenga completamente
            sleep 10

            # Ahora sí podemos eliminar los secretos antiguos
            sudo docker secret rm ssl_cert || true
            sudo docker secret rm ssl_key || true

            # Crear los nuevos secretos
            echo "🔐 Creando nuevos secretos SSL..."
            echo "${{ secrets.SSL_CERT }}" | sudo docker secret create ssl_cert -
            echo "${{ secrets.SSL_KEY }}" | sudo docker secret create ssl_key -

            echo "✅ Secrets actualizados"
            echo "🚀 Despliegue completado: $(date)"